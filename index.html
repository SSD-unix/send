<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ß–∞—Ç —Å —Ñ–æ—Ç–æ –∏ –∑–≤–æ–Ω–∫–∞–º–∏</title>
  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: #eee;
      padding: 20px;
    }
    #chat {
      height: 400px;
      overflow-y: auto;
      border: 1px solid #444;
      padding: 10px;
      background: #222;
      margin-bottom: 10px;
    }
    .msg {
      margin-bottom: 8px;
      padding: 6px;
      background: #333;
      border-radius: 6px;
    }
    .msg img {
      max-width: 200px;
      display: block;
      margin-top: 5px;
      border-radius: 5px;
    }
    input, button {
      background: #333;
      color: #eee;
      border: 1px solid #555;
      padding: 6px;
      margin: 4px 0;
    }
  </style>
</head>
<body>
  <h2>üì± –ß–∞—Ç —Å —Ñ–æ—Ç–æ –∏ –∞—É–¥–∏–æ-–∑–≤–æ–Ω–∫–∞–º–∏</h2>
  <p>–í–∞—à ID: <span id="myid">...</span></p>

  <div id="chat"></div>

  <input type="text" id="to" placeholder="–ö–æ–º—É (ID –∏–ª–∏ all)">
  <input type="text" id="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
  <input type="file" id="photo" accept="image/*">
  <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

  <hr>
  <h3>üîä –ê—É–¥–∏–æ-–∑–≤–æ–Ω–æ–∫</h3>
  <input type="text" id="callTo" placeholder="ID –¥–ª—è –∑–≤–æ–Ω–∫–∞">
  <button onclick="startCall()">–ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
  <audio id="remoteAudio" autoplay></audio>

  <script>
    const SERVER = "https://send-gvt0.onrender.com";
    const clientId = crypto.randomUUID();
    document.getElementById("myid").textContent = clientId;

    // ===== –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è =====
    fetch(SERVER + "/register", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id: clientId })
    }).then(r => console.log("‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω"));

    // ===== –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π =====
    async function pollMessages() {
      try {
        const res = await fetch(`${SERVER}/messages/${clientId}`);
        const data = await res.json();
        for (const msg of data.messages || []) {
          const div = document.createElement("div");
          div.className = "msg";
          div.innerHTML = `<b>${msg.from} ‚Üí ${msg.to}</b>: ${msg.text || ""}`;
          if (msg.image) {
            const img = document.createElement("img");
            img.src = msg.image;
            div.appendChild(img);
          }
          document.getElementById("chat").appendChild(div);
          document.getElementById("chat").scrollTop = 99999;
        }
      } catch (e) {
        console.warn("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π", e);
      }
      setTimeout(pollMessages, 3000);
    }
    pollMessages();

    // ===== –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ —Ñ–æ—Ç–æ =====
    async function sendMessage() {
      const to = document.getElementById("to").value.trim();
      const text = document.getElementById("text").value.trim();
      const file = document.getElementById("photo").files[0];
      let imageData = null;

      if (file) {
        const reader = new FileReader();
        reader.onload = async () => {
          imageData = reader.result;
          await send(to, text, imageData);
        };
        reader.readAsDataURL(file);
      } else {
        await send(to, text, null);
      }

      document.getElementById("text").value = "";
      document.getElementById("photo").value = "";
    }

    async function send(to, text, image) {
      const payload = { from: clientId, to, text, image };
      const res = await fetch(`${SERVER}/send`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      console.log(await res.text());
    }

    // ===== –ê—É–¥–∏–æ-–∑–≤–æ–Ω–æ–∫ =====
    let localStream, peer;
    async function startCall() {
      const callTo = document.getElementById("callTo").value.trim();
      if (!callTo) return alert("–í–≤–µ–¥–∏—Ç–µ ID –¥–ª—è –∑–≤–æ–Ω–∫–∞");
      peer = new RTCPeerConnection();
      peer.ontrack = e => document.getElementById("remoteAudio").srcObject = e.streams[0];
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      localStream.getTracks().forEach(t => peer.addTrack(t, localStream));
      const offer = await peer.createOffer();
      await peer.setLocalDescription(offer);
      await fetch(`${SERVER}/call`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ from: clientId, to: callTo, offer })
      });
      console.log("üìû –û—Ç–ø—Ä–∞–≤–ª–µ–Ω –∑–≤–æ–Ω–æ–∫");
    }
  </script>
</body>
</html>
