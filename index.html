<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Render Chat + Звонки</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #eee;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    #chat {
      width: 600px;
      height: 400px;
      overflow-y: auto;
      background: #1e1e1e;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 15px;
      box-shadow: 0 0 10px #000;
    }
    video {
      width: 280px;
      border-radius: 10px;
      margin: 5px;
      background: #000;
    }
    .msg {
      margin: 5px 0;
      background: #2a2a2a;
      padding: 5px 10px;
      border-radius: 5px;
      word-wrap: break-word;
    }
    #controls {
      display: flex;
      gap: 10px;
      width: 600px;
      margin-bottom: 10px;
    }
    input, button {
      padding: 10px;
      border: none;
      border-radius: 5px;
    }
    input {
      flex: 1;
    }
    button {
      background: #2b8cff;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #1a5fdb;
    }
  </style>
</head>
<body>
  <h1>💬 Render Chat + 📞 Звонки</h1>
  <p>Ваш ID: <b id="client-id"></b></p>

  <div id="chat"></div>

  <div id="controls">
    <input id="peer-id" placeholder="ID собеседника" />
    <button id="callBtn">📞 Позвонить</button>
  </div>

  <video id="localVideo" autoplay muted></video>
  <video id="remoteVideo" autoplay></video>

  <script>
    const SERVER = "https://send-gvt0.onrender.com";
    const clientId = crypto.randomUUID();
    document.getElementById("client-id").textContent = clientId;

    let pc; // PeerConnection
    let localStream;

    async function startCall() {
      const peerId = document.getElementById("peer-id").value.trim();
      if (!peerId) return alert("Введите ID собеседника");

      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      document.getElementById("localVideo").srcObject = localStream;

      pc = createPeerConnection(peerId);

      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      // Отправляем offer собеседнику
      await sendSignal(peerId, { type: "offer", offer, from: clientId });
    }

    function createPeerConnection(peerId) {
      const pc = new RTCPeerConnection();

      pc.ontrack = (event) => {
        document.getElementById("remoteVideo").srcObject = event.streams[0];
      };

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          sendSignal(peerId, { type: "candidate", candidate: event.candidate, from: clientId });
        }
      };

      return pc;
    }

    async function sendSignal(to, data) {
      await fetch(`${SERVER}/send`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ from: clientId, to, text: "[signal]" + JSON.stringify(data) })
      });
    }

    async function pollSignals() {
      const res = await fetch(`${SERVER}/messages/${clientId}`);
      const text = await res.text();
      if (!text.trim()) return;

      let data;
      try { data = JSON.parse(text); } catch { return; }

      for (const msg of data.messages || []) {
        if (!msg.text.startsWith("[signal]")) continue;

        const signal = JSON.parse(msg.text.slice(8));
        if (signal.type === "offer") {
          await handleOffer(signal.offer, signal.from);
        } else if (signal.type === "answer") {
          await pc.setRemoteDescription(new RTCSessionDescription(signal.answer));
        } else if (signal.type === "candidate") {
          await pc.addIceCandidate(new RTCIceCandidate(signal.candidate));
        }
      }
    }

    async function handleOffer(offer, from) {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      document.getElementById("localVideo").srcObject = localStream;

      pc = createPeerConnection(from);
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      await pc.setRemoteDescription(new RTCSessionDescription(offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      await sendSignal(from, { type: "answer", answer, from: clientId });
    }

    document.getElementById("callBtn").addEventListener("click", startCall);

    setInterval(pollSignals, 2000);
  </script>
</body>
</html>
