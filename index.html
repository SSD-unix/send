<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ß–∞—Ç —Å —Ñ–æ—Ç–æ –∏ –≤–∏–¥–µ–æ</title>
<style>
  body {
    font-family: sans-serif;
    background: #111;
    color: #eee;
    padding: 20px;
  }
  #chat {
    height: 400px;
    overflow-y: auto;
    border: 1px solid #444;
    padding: 10px;
    background: #222;
    margin-bottom: 10px;
  }
  .msg {
    margin-bottom: 10px;
    padding: 8px;
    background: #333;
    border-radius: 6px;
  }
  .msg img, .msg video {
    max-width: 250px;
    margin-top: 5px;
    border-radius: 6px;
    display: block;
  }
  input, button {
    background: #333;
    color: #eee;
    border: 1px solid #555;
    padding: 6px;
    margin: 4px 0;
  }
</style>
</head>
<body>
<h2>üí¨ –ß–∞—Ç —Å —Ñ–æ—Ç–æ –∏ –≤–∏–¥–µ–æ</h2>
<p>–í–∞—à ID: <span id="myid">...</span></p>

<div id="chat"></div>

<input type="text" id="to" placeholder="–ö–æ–º—É (ID –∏–ª–∏ all)">
<input type="text" id="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
<input type="file" id="file" accept="image/*,video/*">
<button id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

<script>
const SERVER = "https://send-gvt0.onrender.com";
const clientId = crypto.randomUUID();
document.getElementById("myid").textContent = clientId;
const chat = document.getElementById("chat");

// ===== –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è =====
fetch(`${SERVER}/register`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ id: clientId, ip: "0.0.0.0", port: 0 })
});

// ===== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç =====
function addMsg(text, url = null, type = null) {
  const div = document.createElement("div");
  div.className = "msg";
  div.textContent = text;
  if (url) {
    if (type.startsWith("image")) {
      const img = document.createElement("img");
      img.src = url;
      div.appendChild(img);
    } else if (type.startsWith("video")) {
      const video = document.createElement("video");
      video.src = url;
      video.controls = true;
      div.appendChild(video);
    }
  }
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

// ===== –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ —Ñ–∞–π–ª–∞ =====
document.getElementById("send").addEventListener("click", async () => {
  const to = document.getElementById("to").value.trim();
  const text = document.getElementById("text").value.trim();
  const file = document.getElementById("file").files[0];

  if (!to && !text && !file) return alert("–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª");

  if (file) {
    const formData = new FormData();
    formData.append("from_id", clientId);
    formData.append("to", to);
    formData.append("file", file);
    formData.append("text", text);

    try {
      const res = await fetch(`${SERVER}/send_video`, {
        method: "POST",
        body: formData
      });
      if (res.ok) {
        addMsg(`‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚Üí ${to}: ${text}`, `/videos/${file.name}`, file.type);
      } else {
        const t = await res.text();
        addMsg("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + t);
      }
    } catch (e) {
      addMsg("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + e);
    }
  } else {
    // –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç
    try {
      const res = await fetch(`${SERVER}/send`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ from: clientId, to, text })
      });
      if (res.ok) addMsg(`‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚Üí ${to}: ${text}`);
      else addMsg("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + (await res.text()));
    } catch (e) {
      addMsg("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + e);
    }
  }

  document.getElementById("text").value = "";
  document.getElementById("file").value = "";
});

// ===== –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π =====
const seen = new Set();
async function pollMessages() {
  try {
    const res = await fetch(`${SERVER}/messages/${clientId}`);
    const data = await res.json();
    for (const msg of data.messages || []) {
      const key = `${msg.from}-${msg.to}-${msg.text}`;
      if (!seen.has(key)) {
        addMsg(`üì© ${msg.from} ‚Üí ${msg.to}: ${msg.text}`, msg.text.startsWith("/video/") ? msg.text : null, msg.type);
        seen.add(key);
      }
    }
  } catch (e) {
    console.warn("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è:", e);
  }
  setTimeout(pollMessages, 3000);
}
pollMessages();
</script>
</body>
</html>
